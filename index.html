<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NIFTY Option Greeks Tracker (Delta & IV)</title>
  <style>
    body {
      background: #111;
      color: #0f0;
      font-family: monospace;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #333;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #222;
    }
    .section-title {
      font-weight: bold;
      font-size: 18px;
      margin-top: 20px;
    }
    .error {
      color: red;
    }
    .success {
      color: #0f0;
    }
  </style>
</head>
<body>
  <h2>NIFTY Option Greeks (Î” & IV)</h2>
  <div id="lastUpdated"></div>

  <table id="liveTable">
    <thead>
      <tr><th>Time</th><th>Strike</th><th>Type</th><th>Delta</th><th>IV</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="section-title">ðŸ“Š Change History (Î” Delta & IV)</div>
  <table id="historyTable">
    <thead>
      <tr><th>Time</th><th>Type</th><th>Strikes</th><th>Avg Î”</th><th>Î” Delta</th><th>Î” IV</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let prev = { CE: { delta: 0, iv: 0 }, PE: { delta: 0, iv: 0 } };
    const history = [];

    async function fetchData() {
      const res = await fetch('https://corsproxy.io/?https://www.nseindia.com/api/option-chain-indices?symbol=NIFTY');
      const text = await res.text();
      const json = JSON.parse(text);

      const atmStrike = Math.round(json.records.data[0].PE.underlyingValue / 50) * 50;
      const strikes = [atmStrike - 50, atmStrike, atmStrike + 50];

      const ceEntries = [], peEntries = [];
      const usedStrikes = [];

      for (const item of json.records.data) {
        if (strikes.includes(item.strikePrice)) {
          usedStrikes.push(item.strikePrice);
          ['CE', 'PE'].forEach(type => {
            if (item[type]) {
              const iv = parseFloat(item[type].impliedVolatility || 0);
              let delta = parseFloat(item[type].delta || 0);
              if (!item[type].delta) {
                const isCall = type === 'CE';
                const S = item[type].underlyingValue;
                const K = item.strikePrice;
                const T = 7 / 365;
                const r = 0.06;
                const sigma = iv / 100 || 0.2;
                const d1 = (Math.log(S / K) + (r + sigma ** 2 / 2) * T) / (sigma * Math.sqrt(T));
                delta = isCall ? cdf(d1) : -cdf(-d1);
              }
              if (type === 'CE') ceEntries.push({ strike: item.strikePrice, delta, iv });
              else peEntries.push({ strike: item.strikePrice, delta, iv });
            }
          });
        }
      }

      updateTables(ceEntries, peEntries, usedStrikes);
    }

    function cdf(x) {
      return (1 + erf(x / Math.sqrt(2))) / 2;
    }

    function erf(x) {
      const sign = x < 0 ? -1 : 1;
      x = Math.abs(x);
      const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741,
            a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
      const t = 1 / (1 + p * x);
      const y = 1 - (((((a5*t + a4)*t + a3)*t + a2)*t + a1)*t)*Math.exp(-x*x);
      return sign * y;
    }

    function updateTables(ce, pe, strikes) {
      const liveBody = document.querySelector('#liveTable tbody');
      liveBody.innerHTML = '';
      const now = new Date().toTimeString().split(' ')[0];

      [...ce, ...pe].forEach(row => {
        const tr = document.createElement('tr');
        const type = ce.includes(row) ? 'CE' : 'PE';
        tr.innerHTML = `<td>${now}</td><td>${row.strike}</td><td>${type}</td><td>${row.delta.toFixed(4)}</td><td>${row.iv.toFixed(2)}</td>`;
        liveBody.appendChild(tr);
      });

      ['CE', 'PE'].forEach(type => {
        const entries = type === 'CE' ? ce : pe;
        const deltaSum = entries.reduce((a, b) => a + b.delta, 0);
        const ivSum = entries.reduce((a, b) => a + b.iv, 0);
        const avgDelta = entries.length ? deltaSum / entries.length : 0;
        const avgIV = entries.length ? ivSum / entries.length : 0;
        const deltaChange = avgDelta - prev[type].delta;
        const ivChange = avgIV - prev[type].iv;

        history.unshift({ time: now, type, strikes: strikes.join(", "), avgDelta, deltaChange, ivChange });

        prev[type].delta = avgDelta;
        prev[type].iv = avgIV;
      });

      const histBody = document.querySelector('#historyTable tbody');
      histBody.innerHTML = history.map(h =>
        `<tr><td>${h.time}</td><td>${h.type}</td><td>${h.strikes}</td><td>${h.avgDelta.toFixed(4)}</td><td>${h.deltaChange.toFixed(4)}</td><td>${h.ivChange.toFixed(2)}</td></tr>`
      ).join('');

      document.querySelector('#lastUpdated').innerHTML = '<span class="success">âœ” Last Updated: ' + now + '</span>';
    }

    fetchData();
    setInterval(fetchData, 60000);
  </script>
</body>
</html>
